from selenium import webdriver
import os, errno
import time
import datetime
import selenium.webdriver.support.ui as ui
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
from selenium.common.exceptions    import NoSuchWindowException
import shutil

driver = webdriver.Chrome('/usr/bin/chromedriver', service_args=['--verbose'], service_log_path="/home/unni/Desktop/MovieForum/chromedriver.log")
driver.get("https://07b0f6efcb50c8cb87eec6c274e234492ef58f94.googledrive.com/host/0B9nqaXjwBKMnNFJvQl84a2tUMGc/index.html")
#wait = ui.WebDriverWait(driver,10)

print("Page is loaded")

def WaitForDataCollectionFinished(driver):

	aDataStatusElement = driver.find_element_by_id("final_status")
	time.sleep( 2 )
	print aDataStatusElement.id
    	aTotalWaitTime = 0
	while aDataStatusElement.text != "All the posts downloaded":
		time.sleep( 5 )
		aTotalWaitTime = aTotalWaitTime + 5
		if aTotalWaitTime > 60:
			break

	if aDataStatusElement.text == "All the posts downloaded":
		print "Data collection finished"

def SilentRemove(filename):
	try:
        	os.remove(filename)
    	except OSError as e: # this would be "except OSError, e:" before Python 2.6
        	if e.errno != errno.ENOENT: # errno.ENOENT = no such file or directory
            		raise # re-raise exception if a different error occured

def DownLoadFile(driver):

	aSrcFileName = "/home/unni/Downloads/moviedata.txt"
	SilentRemove(aSrcFileName)
	anImportLinkElement.click()

	aTotalWait = 0
	while not os.path.exists(aSrcFileName):
		time.sleep( 2 )
		aTotalWait = aTotalWait + 2
		if aTotalWait > 60:
			print "Download wait timed out"
			break;

	print "File download finished"

	aDestFileName = ""
	if os.path.exists(aSrcFileName):
		aDestFileName = "/home/unni/Desktop/MovieForum/data/moviedata_" + datetime.datetime.now().strftime("%d%m%Y_%H%M%S") + ".txt"
		print "The data file is stored at : " + aDestFileName
		shutil.move(aSrcFileName, aDestFileName)

	return aDestFileName

try:
	aGetDataElement = ui.WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "login_button")))

	time.sleep( 2 )

	aGetDataElement.click()

	time.sleep( 5 )

	driver.switch_to_window(driver.window_handles[-1])

	anEmailElement = ui.WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "email")))
	aPasswordElement = ui.WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "pass")))
	aLoginButtonElement = ui.WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "u_0_1")))
	anEmailElement.send_keys("unnikrishnan.r@gmail.com")
	time.sleep( 2 )
	aPasswordElement.send_keys("!r!ykkeda1FAC")
	time.sleep( 2 )

	aLoginButtonElement.click()

	driver.switch_to_window(driver.window_handles[-1])
	WaitForDataCollectionFinished(driver)

	anImportLinkElement = ui.WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.ID, "tfa_src_data")))
	time.sleep( 2 )
	
	aPostsFile = DownLoadFile(driver)
	
	aFileProcessor = MovieDataProcessor(aPostsFile)
	aFileProcessor.Process()
	
finally:
	print("Download finished")
    	driver.quit()



#time.sleep( 5 )


